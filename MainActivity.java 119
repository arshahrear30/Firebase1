package com.hellosmaka.firebasearbongo;

import static android.content.ContentValues.TAG;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.pm.PackageManager;
import android.os.Build;
import android.os.Bundle;
import android.util.Log;
import android.widget.Toast;

import androidx.activity.EdgeToEdge;
import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.content.ContextCompat;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;

import com.google.android.gms.tasks.OnCompleteListener;
import com.google.android.gms.tasks.Task;
import com.google.firebase.messaging.FirebaseMessaging;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);
        askNotificationPermission(); //এটা অবশ্যই Add করতে হবে

        initFirebaseToken(); //119.1




        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -> {
            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            return insets;
        });
    }


    //==---------------------------------------- //119.2
// initFirebaseToken এই মেথডটা তৈরি করে আমরা এর ভিতরে Retrieve the current registration token এর কোড গুলো রাখবো
    private void initFirebaseToken(){
        FirebaseMessaging.getInstance().getToken()
                .addOnCompleteListener(new OnCompleteListener<String>() {
                    @Override
                    public void onComplete(@NonNull Task<String> task) {
                        if (!task.isSuccessful()) {
                            Log.w("FirebaseToken", "Fetching FCM registration token failed", task.getException());
                            return;
                        }

                        // Get new FCM registration token
                        String token = task.getResult();

                       Log.d("fireBaseToken",token);
                    }
                });

    }



    //==----------------------------------------



    //===============শেষ 3rd bracket এর আগে লিখবো
    //Access the device registration token https://firebase.google.com/docs/cloud-messaging/android/client#sample-register
    //https://github.com/firebase/snippets-android/blob/1e298008c7f30b2188d82ba5ea7f30c0e8f73682/messaging/app/src/main/java/com/google/firebase/example/messaging/MyFirebaseMessagingService.java#L59-L76


    private final ActivityResultLauncher<String> requestPermissionLauncher =
            registerForActivityResult(new ActivityResultContracts.RequestPermission(), isGranted -> {
                if (isGranted) {
                    // FCM SDK (and your app) can post notifications.
                } else {
                    // TODO: Inform user that that your app will not show notifications.
                }
            });


    private void askNotificationPermission() {  ////উপরে এটা অবশ্যই Add করতে হবে
        // This is only necessary for API level >= 33 (TIRAMISU)
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU)//API 33 এর বড়/সমান হলে তাহলেই এই কোডটা এক্সিকিউট কর
        {
            if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.POST_NOTIFICATIONS) ==
                    PackageManager.PERMISSION_GRANTED) {
                // FCM SDK (and your app) can post notifications.
            } else if (shouldShowRequestPermissionRationale(android.Manifest.permission.POST_NOTIFICATIONS)) {
                //  বার বার Allow চাওয়ার পরেও ইউজার যখন Don't Allow করে তখন এখানে একটি অ্যালার্ট ডাইলক মেসেজ দেখাবো  সেটাই এখন আমরা এর মাঝে লিখব

                new AlertDialog.Builder(MainActivity.this)
                        .setTitle("Need Notification permission")
                        .setMessage("You must have permission to run the app.")


                        .setPositiveButton("Okay", new DialogInterface.OnClickListener() {
                            @Override
                            public void onClick(DialogInterface dialog, int which) {

                                requestPermissionLauncher.launch(android.Manifest.permission.POST_NOTIFICATIONS);

                                //okay click দিলে Allow /Don't Allow Again Show হবে ।
                            }
                        })



                        .setNegativeButton("no thanks", new DialogInterface.OnClickListener() {
                            @Override
                            public void onClick(DialogInterface dialog, int which) {

                            }
                        })


                        .create()
                        .show();


            } else {
                // Directly ask for the permission
                requestPermissionLauncher.launch(android.Manifest.permission.POST_NOTIFICATIONS);
            }
        }
    }


    //===============
}
